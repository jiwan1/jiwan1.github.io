---
layout: blog
title: 스프링 배치를 이용한 DB, 파일 삭제 적용기
category: blog
tags: [human]  
summary:
image: /images/blog/post2.jpg
comment: true
---
유효기간이 설정 된 메일에 대해서 db와 메일에 첨부된 파일을 삭제를 하기 위해 spring batch를 적용했습니다.


먼저 기본적인 개념들에 대한 이해가 필요합니다. 제가 이해한대로 적어보자면
ItemReader: db상에서 select문을 사용했을 때 결과들 중 하나의 row를 받아옴
ItemProcessor: ItemReader에서 받아온 하나의 row에 대한 데이터 저장(가공)
ItemWriter: db의 데이터를 삭제 또는 수정

여기서 ItemWriter가 수행되는 단위인 chunk와 tasklet이 있습니다.
저는 chunk 단위로 데이터를 처리했기에 간략히 설명하자면
chunk의 크기를 10으로 지정할 경우 ItemReader, ItemProcessor가 10개의 row에 대한 작업을 수행하면 그때 ItemWriter는 10개의 row에 대한 작업을 수행한다고 이해하면 될 것 같습니다. 즉 ItemReader와 ItemProcessor는 하나의 row 단위로 작업울 수행하고, ItemWriter는 chunk 크기 단위로 작업을 수행합니다.
chunk 단위로 트랜잭션을 다루기 때문에 롤백이 되고 다시 작업을 수행할 때 발생할 수 있는 에러나 예외사항들을 잘 처리해 주어야 될 것입니다.
저도 이런부분은 신경쓰지 못하고 아무 오류가 없을 때 삭제가 되는것만 구현이 된 것을 아시고 읽어주셔야 합니다.

db에서 유효기간이 지난 메일의 메일ID와 해당 메일에 첨부된 파일들의 파일ID를 읽어옵니다.
한 개의 메일에 3개의 파일이 첨부되어 있을 경우 3개의 row를 받아옵니다.
파일이 존재하지 않는 경우에는 파일ID는 null값으로 받아오고 1개의 row를 받아옵니다.

아래의 작업을 수행했을 때 예상되는 결과는
1. 특정 시간대에 batch가 실행
2. ItemReader가 메일ID, 파일ID로 이루어진 row 1개를 받아옴
3. 파일ID가 null이 아닌 경우 ItemProcessor는 파일ID에 해당하는 실제 파일을 삭제하고 데이터 저장
4. 10개의 row가 들어오면 ItemWriter는 db에서 해당 데이터 삭제
5. 더이상 데이터가 없을 때까지 2~5를 반복해서 수행


## pom.xml
![image](https://user-images.githubusercontent.com/10074426/52131523-4cf05900-2680-11e9-8ee1-687195aeb285.png)

pom.xml에 위와 같이 dependency를 추가합니다. 버전은 3.0.7입니다.

## ServiceApplication.java
![image](https://user-images.githubusercontent.com/10074426/52129945-3fd16b00-267c-11e9-8562-e3a710abb41d.png)

스프링 배치를 이용하기 위해 @EnableBatchProcessing 어노테이션을 추가합니다.
